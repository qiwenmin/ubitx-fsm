# uBitx fsm版使用说明

uBitx是一个开源的短波业余电台，主要性能如下（来自官网）：

* 接收机
  * 灵敏度：0.2uV
  * 选择性：2.4KHz，由8个晶振构成低纹波SSB滤波器
  * 异频收发（官方版本实现为RIT功能，fsm版本实现为Split功能）
  * 频率：500KHz至30MHz
  * 可切换边带
* 发射机
  * 发射功率：10MHz范围内可达10W，21MHz范围内可达7W，28MHz可达2W
  * 内置CW电键
  * 低失真：使用2个IRF510s与4个2N3904构成推挽模式功放

uBitx fsm是由BG1REN完全重写的固件。最初做这个固件的目的是验证用“有限状态机”模型实现嵌入式系统是否有效。随着实现的功能越来越多，就逐渐形成了一个“足够用”的固件。固件源码以GPL 3许可证开源，项目网址为：https://github.com/qiwenmin/ubitx-fsm。

## Fsm版本的固件功能

Fsm版本的固件的主要功能有：

* 支持LSB、USB、CW、CWR模式的接收和发射
* 支持VFO模式和频道（MEM）模式
* 支持A、B双通道
* 支持SPLIT，可异频异模式操作
* 有20个频道，每个频道可存储A/B两个通道的模式和频率、Split状态和当前激活的通道
* 支持手动键（单声道插头和立体声插头都支持）和自动键（可选Iambic A或B模式，及左右手模式）
* 可调整CW侧音频率、自动键速度、CW停止发射的延迟时间、电键模式
* 可设置ITU分区（1、2或3），根据不同分区设置来限制可发射的频率范围
* 支持ICOM CI-V指令，可以用常用的软件操作电台，支持Ham Radio Deluxe v5.24.0.38、WSJT-X、OmniRig、FlDigi等
* 支持自动发报
* 支持显示开机呼号
* 提供振荡器校准功能（10MHz发射模式校准或Zero Beat接收模式校准），确保频率准确
* 提供BFO校准功能（CW模式和SSB模式分别校准），确保最优的信号质量

## 操作界面

uBitx的操作界面比较简洁：唯一的输出设备是一个16x2的字符LCD，输入设备有：

* 旋转编码器（旋钮）及自带的功能按钮（F按钮）
* 带PTT按钮的MIC
* 电键（支持手动键和自动键）
* 音量电位器及自带的电源开关

## 开机

打开电源后，LCD会显示开机信息。如果没有设置过呼号，则显示默认的开机信息：

![ubitx-welcome](images/ubitx-welcome.png)

如果设置过呼号，则显示带有呼号的开机信息：

![ubitx-welcome-callsign](images/ubitx-welcome-callsign.png)

开机信息中显示有固件版本号。上图中版本号是“0.01”。

如果按下“F-按钮”的同时打开电源，电台会进入“Setup via Serial”模式，在此模式下可以用计算机接上电台来设置呼号和自动发报的内容。此模式将在后文中讲解。

## 主界面

显示完开机信息之后，电台进入主界面。根据电台状态的不同，主界面的显示内容有所不同。

![ubitx-main](images/ubitx-main.png)

从上图中可以看到，主界面的信息主要有：

* 最重要的信息在第二行展示，包括：
  * 通道的模式：是VFO模式还是频道（MEM）模式。如果是VFO模式，则显示V，如果是频道模式，则显示M。
  * 通道：当前工作的是A通道还是B通道。上图中的V-A表示当前选择了VFO模式、A通道。
  * 工作模式：CW、CWR、LSB或USB。上图中为CW模式。
  * 频率：上图中频率为7.023MHz。
* 状态信息及另一个通道的信息在第一行展示，包括：
  * 锁定状态：锁定状态开启的情况下，旋钮旋转时频率或频道都保持不变，防止误碰旋钮导致频率或频道意外变化。开启锁定时，屏幕左上角显示一个锁图标。
  * Split模式：开启Split模式时，会显示S字符。
  * 中部和右侧显示的是另一个通道的模式和频率。
  * 上图中，第一行显示的信息为：开启了锁定、开启了Split、VFO-B的模式和频率分别为USB和14.074MHz。

如果开始发射，无论在什么显示模式下，电台都会进入主界面，并在左上角显示发射图标（一直闪烁），如下图所示：

![ubitx-tx](images/ubitx-tx.png)

在主界面中，可进行的操作有：

* 旋转旋钮：如果没有开启锁定，旋转旋钮能调整频率（VFO模式）或更换频道（频道模式）。
* 短按F按钮（按下时长小于0.8秒）：进入菜单模式。
* 长按F按钮（按下时长大于0.8秒，小于1.6秒）：进入频率调整精度模式。
* 长按F按钮（超过1.6秒）：开启锁定模式或关闭锁定模式。

## 菜单模式

进入菜单模式后，屏幕显示菜单项，如下图所示：

![ubitx-menu](images/ubitx-menu.png)

菜单占用屏幕的第一行，包括：

* 菜单编号：上图中Mode菜单的编号为0。编号从0到9、再从a到z。
* 菜单名称：上图中的Mode为菜单名称。
* 菜单值：上图中的USB为菜单Mode的值。有些菜单没有菜单值。

在菜单模式下短按F按钮，则选择当前菜单功能。如果菜单没有值可选，则直接执行菜单功能。例如切换A/B通道。如果有值，则进入设置值的模式，如下图所示：

![ubitx-menu-value](images/ubitx-menu-value.png)

如图所示，在设置值的模式下，菜单值在一对对角括号中。这时旋转旋钮可以改变菜单值。短按F按钮完成设置。

在菜单中长按F按钮可取消当前选择。

## 频率调整精度模式

在主界面中，如果当前是VFO模式，长按F按钮（介于0.8秒到1.6秒之间）会进入频率调整精度模式：

![ubitx-adj-base](images/ubitx-adj-base.png)

通过旋转旋钮，可以改变调整频率的精度（由频率值上方的三角箭头指示，随旋钮的动作左右移动）。短按F按钮确认，长按F按钮取消。

在VFO模式下，旋转旋钮调整频率值时，频率值变化的最小精度即为在上图的界面中设置的精度。

## 发射操作

在CW模式下（CW、CWR），通过电键来发报。在CW模式下按PTT按钮，则会开始自动发报。

如果没有设置过自动发报的文本，则不会启动自动发报功能。

自动发报过程中，再按一次PTT按钮或按下电键，会停止发报。

在SSB模式下（LSB、USB），按PTT键进行发射。此模式下电键没有发报功能。

如果发射频率超出了业余电台可用的频率范围，电台将不会进入发射状态。这时可以将电台当成一个电码练习器。

## 菜单功能

电台具有两个菜单，一个是普通菜单，一个是系统配置菜单。

普通菜单下，不影响其他的操作，例如发射、用计算机控制电台等。系统配置菜单下，其他功能将被禁用，只有系统菜单功能可用。

### 普通菜单

在主界面中短按F按钮进入普通菜单。菜单功能包括：

* Mode：切换当前通道的模式，可选CW、CWR、LSB或USB。
* A/B：切换当前通道（从A切换到B，或从B切换到A）。
* A=B：将两个通道的模式和频率设置为一样（使用当前通道的值）。
* Split：打开或关闭Split功能。
* V/M：在VFO模式和频道（MEM）模式之间切换。如果所有的频道都是空的，则无法切换到频道模式。
* M&rarr;V：将指定频道中的内容写入VFO。如果所有的频道都是空的，则无法执行此功能。
* MW：将当前的参数写入指定频道。在选择频道时，如果频道号前为M字符，则表示此频道已经保存有数据；如果频道号前为问号，则表示此频道是空的。
* MC：清空指定的频道。如果所有的频道都是空的，则无法执行此功能。
* CW Tone：设置CW的侧音频率，单位是Hz。
* CW WPM：设置自动键的速度。
* CW Delay：设置CW模式停止发射的延时时长，单位是毫秒。
* Key：设置电键模式，可取值为：
  * STRAIGHT：手动键（立体声插头和单声道插头都支持）
  * IAMBIC AL：自动键，模式A，左手
  * IAMBIC AR：自动键，模式A，右手
  * IAMBIC BL：自动键，模式B，左手
  * IAMBIC BR：自动键，模式B，右手
* ITU Rgn：设置ITU分区，中国应该选择3区。
* SYS CONF：进入系统菜单，选择此功能会提示Yes或No，选择Yes进入。
* Exit Menu：退出菜单，回到主界面。

### 系统菜单

在普通菜单中选择“SYS CONF”后，进入系统菜单。菜单功能包括：

* Exit Menu：退出系统菜单。
* 10MHz Calibrat：用10MHz发射模式校准振荡器。后文会讲解如何校准。
* 0-Beat Calibra：用SSB接收模式通过zero beat校准振荡器。后文会讲解如何校准。
* BFO Calibrate：校准BFO。需要在SSB和CW模式下各自执行一次BFO校准。后文会讲解如何校准。
* Reset All：重置所有的设置数据及保存的状态。此功能会将所有的数据清除，包括已经校准的数据，慎用！

## Setup via Serial

在按下F按钮的同时打开电台的电源，会进入到“Setup via Serial”模式，此模式下可以通过计算机来设置电台的一些数据。在这个模式下，电台屏幕会显示“Setup via Serial”，在电台上无法进行任何操作。

在此模式下，用USB电缆连接计算机和电台，在系统正常加载USB转串口驱动程序之后，即可在计算机的系统中找到电台对应的串口设备。用终端软件打开此串口，即可进行设置工作。终端软件的配置参数为：

* 速率：19200
* 数据位、奇偶校验、停止位：8-N-1
* 终端设置：原始模式（RAW mode）、无本地回显（No local echo）

终端软件成功连接电台并打开串口后，在软件中应该能看到如下的输出文字（如果设置过这些数据，则会同时打印出相应的内容）：

```
1. Callsign: 
2. Autokey Text: 

Power off the uBitx when done. Choose [1, 2]:
```

按1或2，根据提示分别设置呼号和自动发报的文本。输入时可用退格键删除错误的字符，最后按回车键完成输入。如果输入过程中需要取消，可以按Ctrl+C键。

设置完毕之后，关闭并重开电台的电源，即可让设置生效。

下面是一个设置过程的例子：

```
1. Callsign: 
2. Autokey Text: 

Power off the uBitx when done. Choose [1, 2]:1

Input Callsign: BG1REN

1. Callsign: BG1REN
2. Autokey Text: 

Power off the uBitx when done. Choose [1, 2]: 2

Input Autokey text: CQ CQ DE BG1REN BG1REN PSE K

1. Callsign: BG1REN
2. Autokey Text: CQ CQ DE BG1REN BG1REN PSE K

Power off the uBitx when done. Choose [1, 2]: 
```

## 电台软件连接电台

电台软件连接uBitx fsm版本的电台，需要用下列设置：

* 速率：19200
* 数据位、奇偶校验、停止位：8-N-1
* 电台类型：ICOM IC-7000

目前实测的完全正常工作的软件有：

* Windows平台
  * Ham Radio Deluxe v5.24.0.38（这是最后的免费版本）
  * WSJT-X
  * OmniRig
* macOs平台
  * WSJT-X
  * FlDigi
* Linux平台
  * WSJT-X

## 校准

### 校准功放偏置

首先需要校准功放偏置（PA BIAS），保障功放处在正常的工作状态。

进行此项校准需要测量电台的工作电流，并需要一个小的一字螺丝刀调整电路板上的两个电位器。

操作详情参见官网的说明：http://www.hfsignals.com/index.php/ubitx-tuneup/

### 校准振荡器主频

电台的振荡器主频可能不准确，可以任选下面的一种方式完成校准。比较而言，方法一更为精确。

校准的过程中，随时可以长按F按钮取消校准操作。

#### 方法一：通过发射10MHz信号的模式进行校准

在系统菜单中选择“10MHz Calibrat”菜单项，进入校准功能。注意，一旦进入校准功能，电台就持续以10MHz左右的频率进行发射，所以应提前接好假负载，以防损坏功放单元。

进入校准功能后，观测电台发射的信号频率（可以使用带频谱功能的SDR或电台、或使用频谱仪、或使用频率计、或使用别的频率准确的电台产生zero beat现象等），旋转旋钮让电台发射的频率为准确的10MHz，即完成了校准，短按F按钮保存校准值。

#### 方法二：通过接收某个已知频率的信号，产生zero beat的现象，来进行校准

将电台设置为SSB模式（LSB或USB），并将频率设置为已知信号的频率（已知信号可以是某个信标台、或是信号发生器、或是一台频率准确的电台发射的CW信号）。如果振荡器主频准确，这时会产生zero beat现象，听不到信号声。如果频率有偏差，根据差异的大小，会听到不同频率的信号声。

选择系统菜单的“0-Beat Calibra”菜单项，进入校准功能，旋转旋钮，使其产生zero beat现象，让信号声正好消失。这时即完成了校准，短按F按钮保存校准值。

### 校准BFO

在校准振荡器主频后，需要校准BFO。

校准BFO的操作，是精调第二中频的频率，使信号的有效部分能正常通过窄带滤波器的带通范围，保障信号的质量最优。

由于CW信号和SSB信号的有效频率分量并不一样，因此需要在CW模式和SSB模式下分别校准BFO。

要校准BFO，首先将电台接收频率和模式设置为已知信号的频率和模式（比如用另一个电台发射的信号），然后在系统菜单中选择“BFO Calibrate”菜单项，进入校准功能。旋转旋钮，让扬声器发出的信号声最响亮、音质最清晰，即完成了校准，短按F按钮保存校准值。

注意：CW模式和SSB模式各自需要进行BFO校准！

## 一些资源

* uBitx fsm固件项目网站：https://github.com/qiwenmin/ubitx-fsm
* uBitx官网：http://www.hfsignals.com/index.php/ubitx/
* 官方固件项目网站：https://github.com/afarhan/ubitx
* Dr. Lee的固件项目网站：https://github.com/phdlee/ubitx